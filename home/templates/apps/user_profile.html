{% extends 'apps/master.html' %} {% load static %} {% block user_profile %}
<div class="container">
    <div class="main-body">
        <!-- Form gửi dữ liệu đến server -->
        <form method="POST" id="profile-form" action="{% url 'user_profile_edit' %}" enctype="multipart/form-data">
            {% csrf_token %}
            <div class="row gutters-sm">
                <!-- Avatar và thông tin liên hệ -->
                <div class="col-md-4 mb-3">
                    <div class="card">
                        <div class="card-body">
                            <div class="d-flex flex-column align-items-center text-center">
                                <div class="form-group">
                                    <div class="d-flex justify-content-center">
                                        {% if user.photo %}
                                        <img src="{{ user.PhotoURL }}" alt="Profile Picture" style="width: 150px; margin-top: 10px; border-radius: 50%; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);"> {% else %}
                                        <img src="{% if user.profile.image %}{{ user.profile.image.url }}{% else %}https://bootdey.com/img/Content/avatar/avatar7.png{% endif %}" alt="User Profile" class="rounded-circle" width="150" style="border: 2px solid #ddd; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);">                                        {% endif %}
                                    </div>
                                    <br>
                                    <label for="photo" id="photo-label" style="display:none;">Profile Picture</label>
                                    <input type="file" id="photo" name="photo" class="form-control" style="display:none;" accept="image/jpeg,image/png,image/gif,image/webp">
                                    <small class="text-muted" style="display:none;" id="photo-hint">Allowed: JPG, PNG, GIF, WebP (max 5MB)</small>
                                    <br>
                                </div>
                                <div class="mt-3">
                                    <h3 class="text-secondary mb-1">{{ user.get_role_display }}</h3>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Thông tin cá nhân -->
                <div class="col-md-8">
                    <div class="card mb-3">
                        <div class="card-body">
                            <!-- <div class="form-group">
                                <div class="d-flex justify-content-center">
                                    {% if user.photo %}
                                    <img src="{{ user.PhotoURL }}" alt="Profile Picture" style="width: 150px; margin-top: 10px; border-radius: 50%; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);"> {% else %}
                                    <img src="{% if user.profile.image %}{{ user.profile.image.url }}{% else %}https://bootdey.com/img/Content/avatar/avatar7.png{% endif %}" alt="User Profile" class="rounded-circle" width="150" style="border: 2px solid #ddd; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);">                                    {% endif %}
                                </div>
                                <br>


                                <label for="photo" id="photo-label" style="display:none;">Profile Picture</label>
                                <input type="file" id="photo" name="photo" class="form-control" style="display:none;" accept="image/jpeg,image/png,image/gif,image/webp">
                                <small class="text-muted" style="display:none;" id="photo-hint">Allowed: JPG, PNG, GIF, WebP (max 5MB)</small>
                                <br>
                            </div> -->
                            <!-- Full Name -->
                            <div class="row">
                                <div class="col-sm-3">
                                    <h6 class="mb-0">Full Name</h6>
                                </div>
                                <div class="col-sm-9 text-secondary">
                                    <input type="text" name="full_name" value="{{ user.get_full_name }}" class="form-control" id="full_name" readonly>
                                </div>
                            </div>
                            <hr>
                            <!-- Email -->
                            <div class="row">
                                <div class="col-sm-3">
                                    <h6 class="mb-0">Email</h6>
                                </div>
                                <div class="col-sm-9 text-secondary">
                                    <input type="email" name="email" value="{{ user.email }}" class="form-control" id="email" readonly>
                                </div>
                            </div>
                            <hr>
                            <!-- Phone -->
                            <div class="row">
                                <div class="col-sm-3">
                                    <h6 class="mb-0">Phone</h6>
                                </div>
                                <div class="col-sm-9 text-secondary">
                                    <input type="text" name="phone" value="{{ user.phone }}" class="form-control" id="phone" readonly>
                                </div>
                            </div>
                            <hr>
                            <!-- Date of Birth -->
                            <div class="row">
                                <div class="col-sm-3">
                                    <h6 class="mb-0">Date of Birth</h6>
                                </div>
                                <div class="col-sm-9 text-secondary">
                                    <input type="date" name="dob" value="{{ user.dob|date:'Y-m-d'|default:'' }}" class="form-control" id="dob" readonly>
                                </div>
                            </div>
                            <hr>
                            <!-- Gender -->
                            <div class="row">
                                <div class="col-sm-3">
                                    <h6 class="mb-0">Gender</h6>
                                </div>
                                <div class="col-sm-9 text-secondary">
                                    <select name="gender" class="form-control" id="gender" disabled>
                                        <option value="" {% if not user.gender %}selected{% endif %}>-- Select --</option>
                                        <option value="Male" {% if user.gender == "Male" %}selected{% endif %}>Male</option>
                                        <option value="Female" {% if user.gender == "Female" %}selected{% endif %}>Female</option>
                                        <option value="Other" {% if user.gender == "Other" %}selected{% endif %}>Other</option>
                                    </select>
                                </div>
                            </div>
                            <hr>
                            <div class="row">
                                <div class="col-sm-3">
                                    <h6 class="mb-0">Address</h6>
                                </div>
                                <div class="col-sm-9 text-secondary">
                                    <input type="type" name="address" value="{{ user.address }}" class="form-control" id="dob" readonly>
                                </div>
                            </div>
                            <hr>
                            {% comment %} Balance {% endcomment %}
                            <div class="row">
                                <div class="col-sm-3">
                                    <h6 class="mb-0">Account Balance</h6>
                                </div>
                                <div class="col-sm-9 text-secondary">
                                    <p>{{ balance|floatformat:2 }} USD</p>
                                </div>
                            </div>
                            <hr>
                    
                            <!-- Buttons -->
                            <button type="button" class="btn btn-primary" onclick="window.location.href='{% url 'transaction_history' %}'">View Transaction</button>
                            <button type="button" class="btn btn-primary" onclick="window.location.href='{% url 'top_up' %}'">Top-up Now</button>
                            <button type="button" class="btn btn-warning" id="edit-btn" onclick="enableEditing()">Edit</button>
                            <button type="submit" class="btn btn-success" id="save-btn" style="display:none;">Save</button>
                            <button type="button" class="btn btn-secondary" id="cancel-btn" style="display:none;" onclick="cancelEditing()">Cancel</button>
                            <button type="button" class="btn btn-danger" onclick="window.location.href='{% url 'delete_account' %}'">Delete Account</button>
                        </div>
                    </div>
                </div>
            </div>
        </form>
    </div>
</div>

<script>
    let originalValues = {};

    function enableEditing() {
        document.querySelectorAll('#profile-form input, #profile-form select').forEach(field => {
            field.readOnly = false;
            field.disabled = false;
            originalValues[field.name] = field.value;
        });

        document.getElementById('photo-label').style.display = 'inline-block';
        document.getElementById('photo').style.display = 'inline-block';

        document.getElementById('edit-btn').style.display = 'none';
        document.getElementById('save-btn').style.display = 'inline-block';
        document.getElementById('cancel-btn').style.display = 'inline-block';
    }

    function cancelEditing() {
        document.querySelectorAll('#profile-form input, #profile-form select').forEach(field => {
            field.value = originalValues[field.name];
            field.readOnly = true;
            field.disabled = true;
        });

        // Clear all error messages
        document.querySelectorAll('.field-error').forEach(el => el.remove());
        document.querySelectorAll('.is-invalid').forEach(el => el.classList.remove('is-invalid'));

        document.getElementById('photo-label').style.display = 'none';
        document.getElementById('photo').style.display = 'none';

        document.getElementById('edit-btn').style.display = 'inline-block';
        document.getElementById('save-btn').style.display = 'none';
        document.getElementById('cancel-btn').style.display = 'none';
    }

    function showFieldError(field, message) {
        // Remove existing error
        const existingError = field.parentNode.querySelector('.field-error');
        if (existingError) existingError.remove();
        
        // Add error class
        field.classList.add('is-invalid');
        
        // Create error message
        const errorDiv = document.createElement('div');
        errorDiv.className = 'field-error text-danger small mt-1';
        errorDiv.textContent = message;
        field.parentNode.appendChild(errorDiv);
    }

    function clearFieldError(field) {
        field.classList.remove('is-invalid');
        const existingError = field.parentNode.querySelector('.field-error');
        if (existingError) existingError.remove();
    }

    function validateForm() {
        let isValid = true;
        
        // Validate Full Name
        const fullName = document.getElementById('full_name');
        if (!fullName.value.trim()) {
            showFieldError(fullName, 'Vui lòng nhập họ tên.');
            isValid = false;
        } else if (fullName.value.trim().length < 2) {
            showFieldError(fullName, 'Họ tên phải có ít nhất 2 ký tự.');
            isValid = false;
        } else {
            clearFieldError(fullName);
        }
        
        // Validate Email
        const email = document.getElementById('email');
        const emailRegex = /^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/;
        if (!email.value.trim()) {
            showFieldError(email, 'Vui lòng nhập email.');
            isValid = false;
        } else if (!emailRegex.test(email.value.trim())) {
            showFieldError(email, 'Email không hợp lệ.');
            isValid = false;
        } else {
            clearFieldError(email);
        }
        
        // Validate Phone
        const phone = document.getElementById('phone');
        const phoneRegex = /^\+?\d{10,15}$/;
        const cleanedPhone = phone.value.replace(/[\s\-\(\)]/g, '');
        if (!phone.value.trim()) {
            showFieldError(phone, 'Vui lòng nhập số điện thoại.');
            isValid = false;
        } else if (!phoneRegex.test(cleanedPhone)) {
            showFieldError(phone, 'Số điện thoại phải có 10-15 chữ số.');
            isValid = false;
        } else {
            clearFieldError(phone);
        }
        
        // Validate Date of Birth
        const dob = document.getElementById('dob');
        if (!dob.value.trim()) {
            showFieldError(dob, 'Vui lòng nhập ngày sinh.');
            isValid = false;
        } else {
            const dobDate = new Date(dob.value);
            const today = new Date();
            const age = today.getFullYear() - dobDate.getFullYear();
            if (dobDate > today) {
                showFieldError(dob, 'Ngày sinh không thể ở tương lai.');
                isValid = false;
            } else if (age < 13) {
                showFieldError(dob, 'Bạn phải ít nhất 13 tuổi.');
                isValid = false;
            } else if (age > 120) {
                showFieldError(dob, 'Ngày sinh không hợp lệ.');
                isValid = false;
            } else {
                clearFieldError(dob);
            }
        }
        
        // Validate Gender
        const gender = document.getElementById('gender');
        if (!gender.value) {
            showFieldError(gender, 'Vui lòng chọn giới tính.');
            isValid = false;
        } else {
            clearFieldError(gender);
        }
        
        // Validate Address
        const address = document.querySelector('input[name="address"]');
        if (!address.value.trim()) {
            showFieldError(address, 'Vui lòng nhập địa chỉ.');
            isValid = false;
        } else if (address.value.trim().length < 5) {
            showFieldError(address, 'Địa chỉ phải có ít nhất 5 ký tự.');
            isValid = false;
        } else {
            clearFieldError(address);
        }
        
        return isValid;
    }

    // Add form submit handler
    document.getElementById('profile-form').addEventListener('submit', function(e) {
        if (!validateForm()) {
            e.preventDefault();
        }
    });

    // Real-time validation on input
    document.querySelectorAll('#profile-form input, #profile-form select').forEach(field => {
        field.addEventListener('input', function() {
            if (this.classList.contains('is-invalid')) {
                validateForm();
            }
        });
    });
</script>

<style>
    .is-invalid {
        border-color: #dc3545 !important;
        box-shadow: 0 0 0 0.2rem rgba(220, 53, 69, 0.25) !important;
    }
    .field-error {
        color: #dc3545;
        font-size: 12px;
        margin-top: 4px;
    }
</style>
{% endblock %}